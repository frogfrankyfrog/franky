var open_notif_status=!0;
$(function(){function k(){1==g&&1==f&&($("#notiLoading").show(),l(),e+=1,g=!1,$("#n_loader_img").show(),$.post(dynamic_site_url+"ajax/notifications/get","page="+e,function(a){webSiteTitleNotifNumStatus&&$(document).attr("title",webSiteTitle);if("error"!=a&&"notif_empty"!=a){$(".remove_notif_loading").remove();g=!0;a=JSON.parse(a);for(var b=notifications_html="",c=0;c<a.length;c++){if(0==a[c].status)b="websiteAlert"!=a[c].type?b+'<table class ="notiCont">':b+('<table class ="notiCont webAlert" data-nid="'+a[c].notifications_id+
'">'),b+='<tr><td><a href="'+a[c].ref+'" class="notif_url" data-notif_id="'+a[c].notifications_id+'" data-read="0">';else{var b=b+'<table class ="notiCont visited">',d=a[c].ref;""!=d&&null!=d&&(null!=d.match("notif_r=")?(d=d.replace(/.?notif_r=.{36}/,""),b+='<tr><td><a href="'+d+'" class="notif_url" data-notif_id="'+a[c].notifications_id+'" data-read="1">'):b+='<tr><td><a href="'+a[c].ref+'" class="notif_url" data-notif_id="'+a[c].notifications_id+'" data-read="1">')}b+='<img src="'+a[c].img+'" class="notiPic">';
b=0==a[c].status?b+('<div class="notiTitle notif_url" href="'+a[c].ref+'" data-notif_id="'+a[c].notifications_id+'" data-read="0">'):b+'<div class="notiTitle" >';switch(a[c].type){case "posts":b+='<div class="notiIcon report"></div>';break;case "post_comment":b+='<div class="notiIcon msg"></div>';break;case "news_comment":b+='<div class="notiIcon msg"></div>';break;case "post_emotion":b+='<div class="notiIcon feeling"></div>';break;case "expert_new_reader":b+='<div class="notiIcon rss"></div>';break;
case "expert_new_post":b+='<div class="notiIcon rss"></div>'}b+=a[c].notifications_txt;b+='<div class="notiTime">'+a[c].dtime+"</div>";b+="</div></a></td>";"posts"==a[c].type||"post_comment"==a[c].type||"news_comment"==a[c].type||"post_emotion"==a[c].type?h.match(/(iPhone|iPad|iPod|Android)/)?b+='<td style="width:6px"></td>':(b+="<td >",b="0"==a[c].close?b+('<a href="javascript:void(0)" class="close_notif off" data-nid="'+a[c].notifications_id+'" data-close="'+a[c].close+'" ></a></td>'):b+('<a href="javascript:void(0)" class="close_notif on" data-nid="'+
a[c].notifications_id+'" data-close="'+a[c].close+'" ></a></td>')):"expert_new_post"==a[c].type?(b+="<td>","0"==a[c].close?b+='<a href="javascript:void(0)" class="user_reader_notif rssOff" data-fuid="'+a[c].follow_uid+'" ></a>':"1"==a[c].close&&(b+='<a href="javascript:void(0)" class="user_reader_notif rssOn" data-fuid="'+a[c].follow_uid+'" ></a>'),b+="</td>"):b+="<td></td>";b+="</tr></table>"}n_start=10*(e-1)+1;n_end=10*(e-1)+c+1;r(n_start,n_end,a[0].n_rows);$(".notiIn").append(b);f&&$(".notiIn").append("<table class='remove_notif_loading notiCont visited'></table>");
h.match(/(iPhone|iPad|iPod|Android)/)?setTimeout(function(){"undefined"!=typeof notifScroll&&null!=notifScroll?(notifScroll.refresh(),$(".remove_notif_loading").remove(),$("#notiLoading").hide()):(setTimeout(function(){$("#notiBox").stop(!0,!1).slideDown(300);$("#notiBoxArrow").show();clearTimeout(uunreadCount);user_unread_service_count();notifScroll=new IScroll(".notiOut",{mouseWheel:!0,click:!0,scrollbars:!0,interactiveScrollbars:!0,shrinkScrollbars:"clip"});notifScroll.on("scrollEnd",function(){this.y==
this.maxScrollY&&f&&(l(),k(e))})},300),setTimeout(function(){notifScroll.refresh();$(".remove_notif_loading").remove();$("#notiLoading").hide()},500))},10):(m&&($("#notiBox").stop(!0,!1).slideDown(300),$("#notiBoxArrow").show(),clearTimeout(uunreadCount),user_unread_service_count(),m=!1,t()),p=$(".notiIn").innerHeight()+$("#notiBox h3").innerHeight(),400<=p&&$(".notiIn").css({overflowY:"scroll",height:364,paddingRight:1}),$(".notiIn").niceScroll({autohidemode:!1,cursorcolor:"#AAAAAA",cursorwidth:"6px",
hwacceleration:!0,nativeparentscrolling:!1}),$("#notiLoading").hide())}else"notif_empty"==a&&($("#notiLoading").hide(),b="",b='<div id="notif_empty_div" style="color: rgb(255, 255, 255); font-size: 19px; text-align: center; line-height: 50px; width: 100%; background-color: rgba(1, 195, 224, 0.701961);">\u76ee\u524d\u6c92\u6709\u4efb\u4f55\u901a\u77e5</div>',$(".notiIn").append(b),$("#notiBox").stop(!0,!1).slideDown(300),$("#notiBoxArrow").show(),clearTimeout(uunreadCount),user_unread_service_count());
$(".notiOpen").addClass("noOn")}))}function l(){var a=document.body.clientWidth,b=$("#mmHeader").find($(".notiOpen")).offset().left;if(660>=a||h.match(/(iPhone|iPad|iPod|Android)/))$("#notiBox").css("right","0px");else{var c=a-b-34;$("#notiBox").css("right",c+"px")}a=a-b-24;$("#notiBoxArrow").css("right",a+"px")}function r(a,b,c){0==c&&(f=!1);f=b>=c?!1:!0}function q(){if(!$("#notiBox").is(":hidden")){if(400>=document.body.clientHeight){var a=document.body.clientHeight-31-43-5;$("#notiBox").css("max-height",
a+"px");a-=43;$(".notiOut").css("max-height",a+"px")}else $("#notiBox").css("max-height","400px"),$(".notiOut").css("max-height","357px");h.match(/(iPhone|iPad|iPod|Android)/)?"undefined"!=typeof notifScroll&&null!=notifScroll&&notifScroll.refresh():$(".notiIn").getNiceScroll().resize()}}function t(){$(".notiIn").scroll(function(){$(".notiIn").scrollTop()+$(".notiIn").height()>=$(".notiIn")[0].scrollHeight-$(".notiIn")[0].scrollHeight*(1-.95)&&g&&f&&k(e)})}var e=0,g=!0,f=!0,h=navigator.userAgent,
m=!0;$(".notiOpen").on("click",function(){e=0;$(this);$("#notiBox").stop(!0,!1).slideUp(300);$("#notiBoxArrow").hide();0==$(".notiOpen").hasClass("noOn")?(f=!0,e=0,g=!0,k(),660>=document.body.clientWidth&&$("#mmMenuSwitch").hasClass("on")&&$("#mmMenuSwitch").click(),open_notif_status=!1,$("#mmHeaderW .search").hasClass("on")&&$("#mmHeaderW .search").removeClass("on")):("undefined"!=typeof notifScroll&&null!=notifScroll&&(notifScroll.destroy(),notifScroll=null),$("#notiBox").stop(!0,!1).slideUp(300),
$("#notiBoxArrow").hide(),$(".notiOpen").removeClass("noOn"),open_notif_status=m=!0,$(".notiIn").unbind(),$(".notiIn").empty())});var p;$(window).resize(function(){$("#notiBox").is(":hidden")||(l(),q())});$(document).on("click",".notif_url",function(a){a.preventDefault();var b=$(this);0==b.data("read")&&(a={nid:b.data("notif_id"),_token:token},$.post(dynamic_site_url+"ajax/notifications/read",a,function(a){}));setTimeout(function(){var a=b.attr("href"),a=a.split("#"),a=a[0],d=location.href,d=d.split("#"),
d=d[0];a==d?window.location.reload():window.location.href=b.attr("href")},800)});$(document).on("click",".close_notif",function(){notif_item=$(this);nid=notif_item.data("nid");"0"==notif_item.data("close")?$.post(dynamic_site_url+"ajax/notifications/close","nid="+nid+"&close_type="+notif_item.data("close"),function(){notif_item.data("close","1");notif_item.removeClass("off");notif_item.addClass("on")}):$.post(dynamic_site_url+"ajax/notifications/close","nid="+nid+"&close_type="+notif_item.data("close"),
function(){notif_item.data("close","0");notif_item.removeClass("on");notif_item.addClass("off")})});var n=!0;$(document).on("click",".user_reader_notif",function(){var a=$(this),b=a.data("fuid");if(n){n=!1;if(a.hasClass("rssOff")){$(".user_reader_notif.rssOff[data-fuid='"+b+"']").addClass("rssOn");$(".user_reader_notif.rssOff[data-fuid='"+b+"']").removeClass("rssOff");var c=0}else a.hasClass("rssOn")&&($(".user_reader_notif.rssOn[data-fuid='"+b+"']").addClass("rssOff"),$(".user_reader_notif.rssOn[data-fuid='"+
b+"']").removeClass("rssOn"),c=1);$.post(dynamic_site_url+"ajax/user/follow",{nuid:b,follow_status:c,_token:token},function(){n=!0})}});$(window).load(function(){q()});$(document).on("click",function(a){a=$(a.target);a.is("#notiBox *")||a.is(".notiOpen")||a.is("#headerW_notif")||$(".notiOpen").hasClass("noOn")&&$(".notiOpen").click()});$(document).on("click",".webAlert",function(){wbalert=$(this);wbalert.removeClass("webAlert");var a={nid:$(this).data("nid"),_token:token};$.post(dynamic_site_url+
"ajax/notifications/read",a,function(a){wbalert.addClass("visited");user_unread_service_count()})});$(document).on("click","#noti_allRead",function(){$.post(http_url+"ajax/notifications/allRead",function(){$(".notiCont").addClass("visited")})})});